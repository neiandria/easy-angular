<div class="p-6 bg-gray-50 min-h-screen">
  <div class="max-w-2xl mx-auto bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-bold text-blue-800 mb-4">
      Agendar Nova Consulta
      <span *ngIf="selectedPaciente" class="text-base text-gray-600">- {{ selectedPaciente?.nome }}</span>
    </h2>

    <div class="flex items-center mb-6">
      <ng-container *ngFor="let lbl of getStepLabels(); let idx = index">
        <div class="flex-1 text-center">
          <div
            class="mx-auto w-8 h-8 rounded-full flex items-center justify-center mb-1"
            [ngClass]="step === idx+1 ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-600'">
            {{ idx+1 }}
          </div>
          <div class="text-sm" [ngClass]="step === idx+1 ? 'text-blue-600' : 'text-gray-500'">
            {{ lbl }}
          </div>
        </div>
      </ng-container>
    </div>

    <ng-container [ngSwitch]="step">
      <!-- Step 1: select patient or specialty -->
      <div *ngSwitchCase="1">
        <div *ngIf="!paciente">
          <label class="block mb-2">Paciente</label>
          <select [(ngModel)]="selectedPaciente" class="w-full border rounded p-2 mb-4">
            <option [ngValue]="null" disabled>-- Selecione --</option>
            <option *ngFor="let p of dataService.getPacientes() | async" [ngValue]="p">
              {{ p.nome }}
            </option>
          </select>
        </div>
        <div *ngIf="paciente || selectedPaciente">
          <label class="block mb-2">Especialidade</label>
          <select [(ngModel)]="selectedSpecialty" (change)="onSelectSpecialty()" class="w-full border rounded p-2 mb-4">
            <option [ngValue]="null" disabled selected>-- Selecione --</option>
            <option *ngFor="let esp of specialties" [value]="esp">{{ esp }}</option>
          </select>
        </div>
        <div class="flex justify-between">
          <button *ngIf="step>1" (click)="prevStep()" class="bg-gray-300 px-4 py-2 rounded">Voltar</button>
          <button (click)="nextStep()" [disabled]="!(paciente||selectedPaciente)||!selectedSpecialty"
                  class="bg-blue-600 px-4 py-2 rounded text-white disabled:opacity-50">
            Próximo
          </button>
        </div>
      </div>

      <!-- Step 2: doctor -->
      <div *ngSwitchCase="2">
        <label class="block mb-2">Médico</label>
        <select [(ngModel)]="selectedDoctorId" class="w-full border rounded p-2 mb-4">
          <option [value]="null" disabled>-- Selecione --</option>
          <option *ngFor="let d of doctors" [value]="d.id_medico">{{ d.nome }}</option>
        </select>
        <div class="flex justify-between">
          <button (click)="prevStep()" class="bg-gray-300 px-4 py-2 rounded">Voltar</button>
          <button (click)="nextStep()" [disabled]="!selectedDoctorId"
                  class="bg-blue-600 px-4 py-2 rounded text-white disabled:opacity-50">Próximo</button>
        </div>
      </div>

      <!-- Step 3: date -->
      <div *ngSwitchCase="3">
        <label class="block mb-2">Data</label>
        <div class="grid grid-cols-7 text-sm text-gray-500 mb-2"><div *ngFor="let wd of weekDays">{{ wd }}</div></div>
        <div class="grid grid-cols-7 mb-4">
          <button *ngFor="let day of calendarDays" (click)="selectDate(day.date)" [disabled]="!day.currentMonth"
                  class="w-8 h-8 m-0.5 rounded-full" [ngClass]="day.currentMonth?(isSelected(day.date)?'bg-blue-600 text-white':'hover:bg-blue-100'): 'text-gray-300'">
            {{ day.date.getDate() }}</button>
        </div>
        <div class="flex justify-between mb-4">
          <button (click)="generateCalendar(-1)" class="bg-gray-300 px-4 py-2 rounded">&lt; Mês Ant.</button>
          <button (click)="generateCalendar(1)" class="bg-gray-300 px-4 py-2 rounded">Próx. Mês &gt;</button>
        </div>
        <div class="flex justify-between">
          <button (click)="prevStep()" class="bg-gray-300 px-4 py-2 rounded">Voltar</button>
          <button (click)="nextStep()" [disabled]="!selectedDate" class="bg-blue-600 px-4 py-2 rounded text-white disabled:opacity-50">Próximo</button>
        </div>
      </div>

      <!-- Step 4: time -->
      <div *ngSwitchCase="4">
        <label class="block mb-2">Horário</label>
        <div class="grid grid-cols-3 gap-2 mb-4">
          <button *ngFor="let t of times" (click)="selectTime(t)" [disabled]="!isTimeAvailable(t)"
                  class="py-2 rounded" [ngClass]="t===selectedTime?'bg-blue-600 text-white':'bg-gray-100'">{{ t }}</button>
        </div>
        <div class="flex justify-between">
          <button (click)="prevStep()" class="bg-gray-300 px-4 py-2 rounded">Voltar</button>
          <button (click)="nextStep()" [disabled]="!selectedTime" class="bg-blue-600 px-4 py-2 rounded text-white disabled:opacity-50">Próximo</button>
        </div>
      </div>

      <!-- Step 5: summary -->
      <div *ngSwitchCase="5">
        <h3 class="font-semibold mb-4">Resumo</h3>
        <p><strong>Paciente:</strong> {{ selectedPaciente?.nome }}</p>
        <p><strong>Especialidade:</strong> {{ selectedSpecialty }}</p>
        <p><strong>Médico:</strong> {{ getDoctorName() }}</p>
        <p><strong>Data:</strong> {{ selectedDate | date:'dd/MM/yyyy' }}</p>
        <p><strong>Horário:</strong> {{ selectedTime }}</p>
        <div class="flex justify-between mt-4">
          <button (click)="prevStep()" class="bg-gray-300 px-4 py-2 rounded">Voltar</button>
          <button (click)="confirmarAgendamento()" class="bg-green-600 px-4 py-2 rounded text-white">Confirmar</button>
        </div>
      </div>
    </ng-container>

    <div *ngIf="showConfirmation" class="mt-4 bg-green-100 p-4 rounded">
      Consulta agendada com sucesso!
      <button (click)="voltarDashboard()" class="block mt-2 bg-blue-600 px-4 py-2 rounded text-white">OK</button>
    </div>
  </div>
</div>
